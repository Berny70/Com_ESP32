üîß GUIDE DE D√âPANNAGE COMPLET
ESP32-S3 CAM - D√©tecteur Frelon Asiatique

üìë TABLE DES MATI√àRES

Probl√®mes de compilation
Probl√®mes de t√©l√©versement
Probl√®mes au d√©marrage
Probl√®mes cam√©ra
Probl√®mes de stockage (FFat)
Probl√®mes WiFi
Probl√®mes deep sleep
Probl√®mes batterie
Diagnostics avanc√©s
FAQ


1. PROBL√àMES DE COMPILATION
‚ùå Erreur: "esp_camera.h: No such file or directory"
CAUSE: Biblioth√®que ESP32 non install√©e ou mauvaise version
SOLUTION:
1. Arduino IDE ‚Üí Outils ‚Üí Type de carte ‚Üí Gestionnaire de cartes
2. Chercher "ESP32"
3. Installer "ESP32 by Espressif Systems" version 3.0.0 ou sup√©rieure
4. Red√©marrer Arduino IDE

‚ùå Erreur: "FRAMESIZE_VGA was not declared"
CAUSE: Version ESP32 trop ancienne
SOLUTION:
1. Gestionnaire de cartes
2. Mettre √† jour "ESP32" vers derni√®re version (‚â• 3.0.0)

‚ùå Erreur: "FFat.h: No such file or directory"
CAUSE: Carte mal s√©lectionn√©e
SOLUTION:
Outils ‚Üí Type de carte ‚Üí ESP32S3 Dev Module
(PAS "ESP32 Dev Module")

‚ùå Erreur: "WebServer.h: No such file or directory"
CAUSE: Conflit avec biblioth√®que externe
SOLUTION:
1. Supprimer toute biblioth√®que WebServer externe
2. Utiliser uniquement celle fournie par ESP32
3. Croquis ‚Üí Inclure une biblioth√®que ‚Üí G√©rer les biblioth√®ques
4. D√©sinstaller "WebServer" si pr√©sent

‚ùå Erreur: Sketch trop grand
Le croquis utilise 1900000 octets (142%) de l'espace de stockage
CAUSE: Partition APP trop petite
SOLUTION:
Outils ‚Üí Partition Scheme ‚Üí 16M Flash (3MB APP/9.9MB FATFS)

2. PROBL√àMES DE T√âL√âVERSEMENT
‚ùå "Failed to connect to ESP32"
CAUSE 1: Port COM incorrect
SOLUTION:
1. V√©rifier Gestionnaire de p√©riph√©riques (Windows)
2. Outils ‚Üí Port ‚Üí S√©lectionner bon port COM
3. D√©brancher/rebrancher USB
CAUSE 2: Drivers manquants
SOLUTION:
Windows:
1. T√©l√©charger CP210x ou CH340 drivers
2. https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers

Mac/Linux:
G√©n√©ralement d√©tect√© automatiquement
CAUSE 3: ESP32 en deep sleep
SOLUTION:
1. Appuyer et MAINTENIR bouton BOOT
2. Cliquer "T√©l√©verser"
3. Rel√¢cher BOOT apr√®s "Connecting..."

‚ùå "Timed out waiting for packet header"
SOLUTION:
1. R√©duire Upload Speed:
   Outils ‚Üí Upload Speed ‚Üí 115200 (au lieu de 921600)

2. Essayer avec bouton BOOT:
   - Maintenir BOOT enfonc√©
   - Appuyer bri√®vement RESET
   - Rel√¢cher BOOT
   - Cliquer T√©l√©verser

‚ùå "MD5 of file does not match"
SOLUTION:
1. C√¢ble USB d√©fectueux ‚Üí Changer c√¢ble
2. Port USB faible ‚Üí Essayer autre port USB
3. Upload Speed ‚Üí R√©duire √† 115200

3. PROBL√àMES AU D√âMARRAGE
‚ùå LED clignote rapidement (erreur partition)
SYMPT√îME: Moniteur s√©rie affiche "ERREUR PARTITION"
SOLUTION:
1. Outils ‚Üí Partition Scheme ‚Üí 16M Flash (3MB APP/9.9MB FATFS)
2. Re-t√©l√©verser le code
3. Si persiste: Effacer flash compl√®tement
   Outils ‚Üí Erase Flash ‚Üí All Flash Contents
   Puis re-t√©l√©verser

‚ùå "Brownout detector was triggered"
SYMPT√îME: Red√©marrage en boucle
CAUSE: Alimentation insuffisante
SOLUTION:
1. V√©rifier alimentation ‚â• 500mA (id√©al: 1A)
2. Ajouter condensateur 100-470¬µF sur VCC
3. C√¢ble USB court et de qualit√©
4. Ne PAS alimenter par pin 3.3V (utiliser 5V)

‚ùå Moniteur s√©rie affiche caract√®res illisibles
CAUSE: Mauvais baud rate
SOLUTION:
Moniteur s√©rie ‚Üí S√©lectionner 115200 baud
(en bas √† droite de la fen√™tre)

‚ùå Rien ne s'affiche au moniteur s√©rie
SOLUTION:
1. V√©rifier port COM correct
2. Outils ‚Üí USB CDC On Boot ‚Üí Enabled
3. Re-t√©l√©verser le code
4. Appuyer bouton RESET sur ESP32

4. PROBL√àMES CAM√âRA
‚ùå "Erreur camera: 0x105"
CAUSE: Cam√©ra non d√©tect√©e (c√¢ble ruban)
SOLUTION:
1. √âteindre ESP32
2. V√©rifier connexion c√¢ble ruban cam√©ra:
   - Bien ins√©r√© des DEUX c√¥t√©s
   - Contacts dor√©s vers le BAS
   - Pas de pli dans le c√¢ble
3. Nettoyer contacts avec alcool isopropylique
4. Red√©marrer

‚ùå "Erreur camera: 0x20001"
CAUSE: PSRAM non d√©tect√©
SOLUTION:
1. V√©rifier configuration:
   Outils ‚Üí PSRAM ‚Üí OPI PSRAM

2. Si erreur persiste:
   Le code se mettra automatiquement en mode d√©grad√© (QVGA)

‚ùå "Echec capture" r√©p√©t√©
SYMPT√îMES: Photos noires ou erreur capture
DIAGNOSTIC:
arduino// Ajouter dans modeCapturePhoto() apr√®s initCamera():
delay(2000);  // Laisser cam√©ra s'initialiser
Serial.println("Test exposition...");
SOLUTIONS:
1. Cam√©ra mal initialis√©e
cpp// Ajouter delay avant capture
delay(1000);
fb = esp_camera_fb_get();
```

**2. Cam√©ra d√©fectueuse**
```
Tester avec exemple de base:
Fichier ‚Üí Exemples ‚Üí ESP32 ‚Üí Camera ‚Üí CameraWebServer
3. Probl√®me exposition
cpp// Dans initCamera(), apr√®s sensor_t * s = ...
s->set_brightness(s, 1);     // Augmenter luminosit√©
s->set_exposure_ctrl(s, 0);  // D√©sactiver auto-exposition
s->set_aec_value(s, 300);    // Exposition manuelle

‚ùå Photos floues
SOLUTION:
cpp// Ajuster focus physique de la cam√©ra
// Tourner d√©licatement la lentille

// OU augmenter qualit√©:
#define JPEG_QUALITY 8  // Au lieu de 12
```

---

## 5. PROBL√àMES DE STOCKAGE (FFat)

### ‚ùå "√âchec montage FFat"

**DIAGNOSTIC:**
```
Ouvrir moniteur s√©rie au boot
Chercher message "FFat: X MB total"
```

**SOLUTION 1:** Formatage n√©cessaire
```
Le code formate automatiquement au 1er boot
Attendre 30 secondes
```

**SOLUTION 2:** Partition incorrecte
```
1. Outils ‚Üí Partition Scheme ‚Üí 16M Flash (3MB APP/9.9MB FATFS)
2. Outils ‚Üí Erase Flash ‚Üí All Flash Contents
3. Re-t√©l√©verser

‚ùå "ERREUR ouverture fichier"
CAUSE: FFat plein ou corrompu
SOLUTION:
cpp// Via interface web:
http://192.168.4.1
‚Üí Cliquer "Supprimer Photos"

// OU reformater:
1. T√©l√©verser ce code temporaire:
void setup() {
  Serial.begin(115200);
  FFat.format();
  Serial.println("Format OK");
}

2. Puis re-t√©l√©verser le code principal
```

---

### ‚ùå Photos disparaissent apr√®s red√©marrage

**CAUSE:** FFat non correctement ferm√©

**V√âRIFICATION:**
```
Le code appelle bien FFat.end() ?
Oui ‚úÖ ‚Üí Corruption possible
SOLUTION:
cpp// Reformater FFat
FFat.format();
```

---

## 6. PROBL√àMES WiFi

### ‚ùå WiFi "Frelon-Cam" n'appara√Æt pas

**DIAGNOSTIC:**
```
Moniteur s√©rie doit afficher:
"WiFi: Frelon-Cam"
"IP: http://192.168.4.1"
```

**SOLUTION 1:** Deep sleep trop rapide
```
V√©rifier que BOUTON a bien d√©clench√© le r√©veil
(pas PIR)
```

**SOLUTION 2:** Erreur FFat bloque WiFi
```
Moniteur s√©rie: chercher "ERREUR FFat"
‚Üí R√©soudre probl√®me FFat d'abord
```

**SOLUTION 3:** Timeout d√©pass√©
```
Le WiFi s'√©teint apr√®s 1 min inactivit√©
R√©-appuyer sur BOUTON
```

---

### ‚ùå Impossible de se connecter au WiFi

**ERREUR:** "Mot de passe incorrect" sur smartphone

**SOLUTION:**
```
Mot de passe: frelon2026
(tout en minuscules, pas d'espaces)

Si modifi√© dans le code:
V√©rifier #define AP_PASSWORD
Minimum 8 caract√®res requis
```

---

### ‚ùå Connect√© au WiFi mais pas d'acc√®s web

**DIAGNOSTIC:**
```
1. V√©rifier IP obtenue sur smartphone:
   Param√®tres WiFi ‚Üí Frelon-Cam ‚Üí Infos
   
2. IP doit √™tre 192.168.4.xxx
```

**SOLUTION:**
```
Navigateur ‚Üí http://192.168.4.1
(PAS https://)

Si √©chec:
- D√©sactiver donn√©es mobiles
- D√©sactiver VPN
- Essayer navigateur diff√©rent (Chrome, Firefox)
```

---

### ‚ùå Page web affiche "Chargement..." ind√©finiment

**CAUSE:** JavaScript bloqu√© ou probl√®me serveur

**SOLUTION:**
```
1. Ouvrir Console d√©veloppeur (F12)
2. Chercher erreurs JavaScript

3. V√©rifier route /list:
   http://192.168.4.1/list
   Doit afficher JSON

4. Si erreur 500:
   ‚Üí Probl√®me FFat
   ‚Üí Voir section FFat ci-dessus
```

---

## 7. PROBL√àMES DEEP SLEEP

### ‚ùå ESP32 ne se met pas en deep sleep

**SYMPT√îME:** Reste actif ind√©finiment

**DIAGNOSTIC:**
```
Moniteur s√©rie doit afficher:
"Configuration Deep Sleep..."
"Entree en Deep Sleep..."
```

**CAUSE 1:** Boucle infinie avant sleep
```
Chercher while(1) ou erreur bloquante dans logs
```

**CAUSE 2:** Serveur web actif
```
Appuyer sur BOUTON active WiFi
‚Üí Normal qu'il reste actif
‚Üí Timeout apr√®s 1 min inactivit√©
```

---

### ‚ùå Ne se r√©veille pas sur PIR

**DIAGNOSTIC:**
```
1. Tester PIR s√©par√©ment:
   - Alimenter PIR en 3.3V
   - LED sur PIR doit s'allumer sur mouvement
   
2. V√©rifier GPIO:
   PIR OUT ‚Üí GPIO 21
```

**SOLUTION:**
```
1. V√©rifier c√¢blage:
   PIR VCC ‚Üí ESP32 3.3V
   PIR GND ‚Üí ESP32 GND
   PIR OUT ‚Üí ESP32 GPIO 21

2. Tester PIR:
   pinMode(21, INPUT);
   Serial.println(digitalRead(21));
   // Doit afficher 1 quand mouvement
```

---

### ‚ùå Ne se r√©veille pas sur BOUTON

**DIAGNOSTIC:**
```
1. Tester bouton:
   Multim√®tre en mode continuit√©
   Appuyer ‚Üí doit sonner

2. V√©rifier GPIO:
   Bouton ‚Üí GPIO 3
```

**SOLUTION:**
```
C√¢blage bouton:
GPIO 3 ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ Bouton (NO) ‚îÄ‚îÄ 3.3V
         ‚îÇ
         ‚îî‚îÄ‚îÄ R√©sistance 10kŒ© ‚îÄ‚îÄ GND

OU plus simple:
GPIO 3 ‚îÄ‚îÄ Bouton (NO) ‚îÄ‚îÄ 3.3V
(pull-down interne activ√© dans le code)
```

---

### ‚ùå Se r√©veille constamment (boucle)

**CAUSE:** GPIO PIR reste HIGH

**SOLUTION:**
```
1. Ajuster sensibilit√© PIR (potentiom√®tre sur module)
2. Ajouter d√©lai avant sleep:

void configurerDeepSleep() {
  delay(5000);  // Attendre 5s que PIR redescende
  // ... reste du code
}

8. PROBL√àMES BATTERIE
‚ùå "BATTERIE CRITIQUE" mais batterie charg√©e
CAUSE: Diviseur de tension incorrect ou ADC mal c√¢bl√©
DIAGNOSTIC:
cpp// Ajouter dans verifierBatterie():
Serial.printf("ADC raw: %d\n", adc);
Serial.printf("Voltage calcule: %.2fV\n", voltage);

// Mesurer batterie avec multim√®tre
// Comparer avec valeur affich√©e
SOLUTION:
cpp// Ajuster formule selon votre diviseur:
// Si diviseur 1:2 (2x 10kŒ©):
float voltage = (adc / 4095.0) * 3.3 * 2.0;

// Si diviseur 1:3 (20kŒ© + 10kŒ©):
float voltage = (adc / 4095.0) * 3.3 * 3.0;

// Si pas de diviseur (batterie 3.7V directe):
float voltage = (adc / 4095.0) * 3.3;
```

---

### ‚ùå Batterie se d√©charge trop vite

**DIAGNOSTIC:**
```
Consommation attendue:
- Deep sleep: ~10¬µA
- Capture photo: ~200mA pendant 2-3s
- WiFi actif: ~150mA

Dur√©e batterie th√©orique (LiPo 2000mAh):
- 10 captures/jour: ~2-3 semaines
- 50 captures/jour: ~1 semaine
```

**SOLUTIONS:**

**1. V√©rifier pas de r√©veil constant**
```
Moniteur s√©rie: compter boots
Si > 100/jour ‚Üí Probl√®me PIR (trop sensible)
2. V√©rifier LED √©teinte
cpppinMode(LED_BUILTIN, OUTPUT);
digitalWrite(LED_BUILTIN, LOW);  // Doit √™tre dans setup()
3. R√©duire timeout WiFi
cpp#define WEB_TIMEOUT_INACTIVITY_MS 30000  // 30s au lieu de 60s
```

---

### ‚ùå Batterie ne charge pas (panneau solaire)

**DIAGNOSTIC:**
```
1. Tester panneau avec multim√®tre:
   Lumi√®re directe ‚Üí doit donner ~5V

2. Tester TP4056:
   LED rouge = en charge
   LED verte = charg√©
```

**SOLUTION:**
```
C√¢blage TP4056:
Panneau 5V+ ‚Üí TP4056 IN+
Panneau GND ‚Üí TP4056 IN-
TP4056 OUT+ ‚Üí ESP32 5V
TP4056 OUT- ‚Üí ESP32 GND
TP4056 BAT+ ‚Üí LiPo +
TP4056 BAT- ‚Üí LiPo -

9. DIAGNOSTICS AVANC√âS
üîç MODE DEBUG COMPLET
Activer logs d√©taill√©s:
cppvoid setup() {
  Serial.begin(115200);
  Serial.setDebugOutput(true);  // ‚Üê AJOUTER
  esp_log_level_set("*", ESP_LOG_VERBOSE);  // ‚Üê AJOUTER
  
  // ... reste du code
}

üîç TESTER CHAQUE COMPOSANT ISOL√âMENT
Test 1: Cam√©ra seule
cppvoid setup() {
  Serial.begin(115200);
  if (initCamera()) {
    Serial.println("Camera OK");
    fb = esp_camera_fb_get();
    if (fb) {
      Serial.printf("Photo OK: %d bytes\n", fb->len);
      esp_camera_fb_return(fb);
    }
  }
}
void loop() {}
Test 2: FFat seul
cppvoid setup() {
  Serial.begin(115200);
  if (FFat.begin(false)) {
    Serial.printf("FFat OK: %d MB\n", FFat.totalBytes()/(1024*1024));
    File test = FFat.open("/test.txt", "w");
    test.println("Test");
    test.close();
    Serial.println("Ecriture OK");
  }
}
void loop() {}
Test 3: WiFi seul
cppvoid setup() {
  Serial.begin(115200);
  WiFi.softAP("Test-AP", "12345678");
  Serial.println(WiFi.softAPIP());
}
void loop() {}

üîç V√âRIFIER M√âMOIRE DISPONIBLE
cppvoid afficherMemoire() {
  Serial.printf("Heap libre: %d bytes\n", ESP.getFreeHeap());
  Serial.printf("PSRAM libre: %d bytes\n", ESP.getFreePsram());
  Serial.printf("Heap min: %d bytes\n", ESP.getMinFreeHeap());
}

// Appeler √† diff√©rents moments:
// - Au boot
// - Apr√®s init cam√©ra
// - Apr√®s capture photo
```

---

### üîç ANALYSER LES LOGS SYST√àME

**Via interface web:**
```
http://192.168.4.1/logs
```

**Chercher patterns:**
```
[Boot:X Photo:Y] ERREUR ...
‚Üí Si X augmente vite: reboot loops
‚Üí Si Y n'augmente pas: photos non sauvegard√©es
```

---

## 10. FAQ

### ‚ùì Combien de photos peut stocker le syst√®me ?

**R√©ponse:**
```
Partition: 9.9 MB
Photo VGA moyenne: ~50 KB
Capacit√© th√©orique: ~200 photos

Limite configur√©e: 20 photos (FIFO)
‚Üí Plus ancienne supprim√©e automatiquement
Modifier limite:
cpp#define MAX_PHOTOS 50  // Au lieu de 20

‚ùì Comment r√©cup√©rer les photos sans smartphone ?
Option 1: Carte SD (n√©cessite modification hardware)
Option 2: USB direct
cpp// Ajouter au d√©but de setup():
#include <USB.h>
#include <USBMSD.h>

// Exposer FFat comme cl√© USB
USBMSD.begin();
Option 3: Serveur FTP (√† impl√©menter)

‚ùì Peut-on avoir plusieurs ESP32 avec m√™me WiFi ?
R√©ponse: Non, conflit SSID
Solution:
cpp// Personnaliser SSID par device:
#define AP_SSID "Frelon-Cam-01"  // Device 1
#define AP_SSID "Frelon-Cam-02"  // Device 2
```

---

### ‚ùì Comment mettre √† jour le code sans tout perdre ?

**Photos sauvegard√©es:**
```
1. Activer mode rel√®ve (bouton)
2. T√©l√©charger toutes les photos
3. T√©l√©verser nouveau code
4. Photos seront perdues
5. Re-uploader si besoin
```

**Pr√©server FFat:**
```
Impossible avec OTA standard
Les photos seront perdues √† chaque flash
```

---

### ‚ùì PIR d√©clenche trop souvent (fausses alarmes)

**Solutions:**
```
1. Ajuster sensibilit√© PIR (potentiom√®tre)
2. Ajuster port√©e PIR (potentiom√®tre)
3. Orienter PIR loin des branches/feuilles
4. Ajouter filtre logiciel:

void modeCapturePhoto() {
  delay(500);  // Attendre stabilisation
  if (digitalRead(GPIO_PIR) == LOW) {
    // Fausse alarme, retour sleep
    return;
  }
  // ... suite capture
}
```

---

### ‚ùì Interface web lente ou photos ne chargent pas

**Causes:**
```
1. Signal WiFi faible
   ‚Üí Se rapprocher de l'ESP32

2. Trop de photos
   ‚Üí Supprimer anciennes

3. Photo trop grosse
   ‚Üí R√©duire qualit√©:
   #define JPEG_QUALITY 15  // Au lieu de 12
```

---

### ‚ùì Comment savoir si le syst√®me fonctionne sans moniteur s√©rie ?

**Indicateurs:**
```
1. V√©rifier logs via WiFi:
   http://192.168.4.1/logs
   
2. Compteur photoIndex augmente
   
3. Fichiers photos pr√©sents

4. Ajouter LED de status (optionnel):
cpp#define LED_STATUS 2

void modeCapturePhoto() {
  // Clignoter 3x = capture r√©ussie
  for(int i=0; i<3; i++) {
    digitalWrite(LED_STATUS, HIGH);
    delay(200);
    digitalWrite(LED_STATUS, LOW);
    delay(200);
  }
}
```

---

## üÜò DERNIER RECOURS : RESET COMPLET

**Si rien ne fonctionne:**
```
1. Outils ‚Üí Erase Flash ‚Üí All Flash Contents
2. T√©l√©verser code
3. Attendre 1 minute (formatage FFat)
4. Appuyer RESET
5. V√©rifier moniteur s√©rie

üìû CHECKLIST DE D√âPANNAGE RAPIDE
Avant de chercher le probl√®me, v√©rifier:

 Port COM correct
 Carte: ESP32S3 Dev Module
 Partition: 16M Flash (3MB APP/9.9MB FATFS)
 PSRAM: OPI PSRAM
 USB CDC On Boot: Enabled
 Moniteur s√©rie: 115200 baud
 C√¢ble USB de qualit√© (donn√©es, pas que charge)
 Alimentation ‚â• 500mA
 C√¢ble ruban cam√©ra bien connect√©
 GPIO pas en conflit
 Batterie charg√©e (si utilis√©e)


üìä TABLEAU DE DIAGNOSTIC RAPIDE
Sympt√¥meCause probablePageNe compile pasBiblioth√®que/carte¬ß1Ne t√©l√©verse pasPort/drivers¬ß2LED clignote vitePartition¬ß3Photos noiresCam√©ra¬ß4Pas de stockageFFat¬ß5WiFi invisibleDeep sleep/erreur¬ß6Ne se r√©veille pasGPIO/c√¢blage¬ß7Batterie vide viteConso/PIR¬ß8

üí° CONSEILS FINAUX

Toujours v√©rifier le moniteur s√©rie - 90% des probl√®mes y sont visibles
Tester composants isol√©ment - Cam√©ra, FFat, WiFi s√©par√©ment
Logs sont vos amis - Consulter /logs via interface web
Ne pas h√©siter √† reformater FFat - R√©sout beaucoup de bugs
V√©rifier alimentation - Cause #1 de comportements bizarres
